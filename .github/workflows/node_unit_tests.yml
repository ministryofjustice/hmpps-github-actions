name: Build and test node

on:
  workflow_call:
    inputs:
      node_version:
        type: string
        required: false
        default: '20.12'

permissions:
  contents: read

jobs:
  node-unit-test:
    name: Run the node unit test
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    - name: Use Node.js ${{ inputs.node_version }}
      uses: actions/setup-node@v4
      with:
        node-version: ${{ inputs.node_version }}
    - name: refresh cache
      id: refresh-cache
      uses: actions/cache@v4
      env: 
        cache-name: node-modules
      with:
        path: | 
          ~/.cache
          node_modules
        key: ${{ runner.os }}-build-${{ env.cache-name }}-${{ hashFiles('**/package-lock.json') }}
        restore-keys: | 
          ${{ runner.os }}-build-${{ env.cache-name }}-
          ${{ runner.os }}-build-
          ${{ runner.os }}-
    - name: unit tests
      shell: bash
      run: |
        sudo npm run test:ci
    - name: upload the artifacts
      uses: actions/upload-artifact@v4
      with: 
        name: npm_unit_test_artifacts
        path: test_results/
