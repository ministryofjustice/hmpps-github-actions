name: Build & push docker image and deploy to environment

on:
  workflow_call:
    inputs:
      docker_registry:
        description: Docker registry
        required: true
        type: string
      registry_org:
        description: Docker registry organisation
        required: true
        type: string
      additional_docker_tag:
        description: Additional docker tag that can be used to specify stable tags
        required: false
        type: string
      tag_latest:
        description: Tag docker image as 'latest'
        required: false
        type: boolean
        default: true
      upload_image_artifact:
        description: Upload image to artifacts in GitHub Actions
        required: false
        type: boolean
        default: false
      image_artifact_retention_days:
        description: Number of days to keep the image in artifacts
        required: false
        type: number
        default: 7
      additional_docker_build_args:
        description: Additional docker build arguments
        required: false
        type: string
      push:
        description: Push docker image to registry flag
        required: true
        type: boolean
      load:
        description: Load docker image into local docker
        required: false
        type: boolean
        default: false
      docker_multiplatform:
        description: Docker image build multiplatform or not
        required: true
        type: boolean
        default: true
      image_name:
        description: Name of the image
        required: false
        type: string
      file:
        description: "Path to the Dockerfile"
        required: false
        type: string
      download_build_artifacts:
        description: Whether to download the build artifacts prior to running the docker build
        required: false
        type: boolean
        default: false
    secrets:
      HMPPS_QUAYIO_USER:
        required: false
      HMPPS_QUAYIO_TOKEN:
        required: false

    outputs:
      app_version:
        description: The version of the app as generated by create_app_version
        value: ${{ jobs.create_version.outputs.version }}

permissions:
  contents: read
  packages: write

jobs:
  create_version:
    name: Create app version
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.app_version.outputs.version }}
    steps:
      - id: app_version
        name: Create application version
        uses: ministryofjustice/hmpps-github-actions/.github/actions/build-test-and-deploy/create_app_version@v2 # WORKFLOW_VERSION

  docker_build:
    name: Build linux/amd64 (single)
    if: ${{ ! inputs.docker_multiplatform }}
    needs: [create_version]
    runs-on: ubuntu-latest
    steps:
      - uses: ministryofjustice/hmpps-github-actions/.github/actions/build-test-and-deploy/build_docker@v2 # WORKFLOW_VERSION
        if: ${{ inputs.docker_registry == 'ghcr.io' }}
        with:
          image_name: ${{ inputs.image_name || github.event.repository.name }}
          docker_registry: ${{ inputs.docker_registry }}
          registry_org: ${{ inputs.registry_org }}
          additional_docker_tag: ${{ inputs.additional_docker_tag }}
          tag_latest: ${{ inputs.tag_latest }}
          upload_image_artifact: ${{ inputs.upload_image_artifact }}
          image_artifact_retention_days: ${{ inputs.image_artifact_retention_days }}
          push: ${{ inputs.push }}
          load: ${{ inputs.load }}
          app_version: ${{ needs.create_version.outputs.version }}
          additional_docker_build_args: ${{ inputs.additional_docker_build_args }}
          file: ${{ inputs.file }}
          download_build_artifacts: ${{ inputs.download_build_artifacts }}

      - uses: ministryofjustice/hmpps-github-actions/.github/actions/build-test-and-deploy/build_docker@v2 # WORKFLOW_VERSION
        if: ${{ inputs.docker_registry == 'quay.io' }}
        with:
          image_name: ${{ inputs.image_name || github.event.repository.name }}
          docker_registry: ${{ inputs.docker_registry }}
          registry_org: ${{ inputs.registry_org }}
          additional_docker_tag: ${{ inputs.additional_docker_tag }}
          tag_latest: ${{ inputs.tag_latest }}
          upload_image_artifact: ${{ inputs.upload_image_artifact }}
          image_artifact_retention_days: ${{ inputs.image_artifact_retention_days }}
          push: ${{ inputs.push }}
          load: ${{ inputs.load }}
          app_version: ${{ needs.create_version.outputs.version }}
          HMPPS_QUAYIO_USER: ${{ secrets.HMPPS_QUAYIO_USER }}
          HMPPS_QUAYIO_TOKEN: ${{ secrets.HMPPS_QUAYIO_TOKEN}}
          additional_docker_build_args: ${{ inputs.additional_docker_build_args }}
          download_build_artifacts: ${{ inputs.download_build_artifacts }}

  docker_build_platform:
    name: Build ${{ matrix.platform }} (parallel)
    if: ${{ inputs.docker_multiplatform }}
    needs: [create_version]
    strategy:
      fail-fast: true
      matrix:
        include:
          - platform: linux/amd64
            runner: ubuntu-latest
          - platform: linux/arm64
            runner: ubuntu-24.04-arm
    runs-on: ${{ matrix.runner }}
    steps:
      - uses: actions/checkout@v6

      - name: Download build artifacts needed for docker build
        if: ${{ inputs.download_build_artifacts }}
        uses: actions/download-artifact@v7
        with:
          name: build-results

      - uses: docker/setup-buildx-action@v3

      - name: Prepare platform pair
        id: prepare
        shell: bash
        run: |
          echo "platform_pair=${platform//\//-}" >> "$GITHUB_OUTPUT"
        env:
          platform: ${{ matrix.platform }}

      - name: Build OCI tarball
        uses: docker/build-push-action@v6
        with:
          context: .
          platforms: ${{ matrix.platform }}
          file: ${{ inputs.file }}
          build-args: |
            "BUILD_NUMBER=${{ needs.create_version.outputs.version }}"
            "GIT_REF=${{ github.sha }}"
            "GIT_BRANCH=${{ github.ref_name }}"
            "${{ inputs.additional_docker_build_args }}"
          outputs: type=oci,dest=${{ runner.temp }}/image.tar
          cache-from: type=gha,scope=build-${{ steps.prepare.outputs.platform_pair }}
          cache-to: type=gha,scope=build-${{ steps.prepare.outputs.platform_pair }},mode=max
          provenance: false

      - name: Upload image tarball
        uses: actions/upload-artifact@v6
        with:
          name: image-${{ steps.prepare.outputs.platform_pair }}
          path: ${{ runner.temp }}/image.tar
          if-no-files-found: error
          retention-days: 1

  docker_build_merge:
    name: Push multi-platform image
    if: ${{ inputs.docker_multiplatform && inputs.push }}
    needs: [create_version, docker_build_platform]
    runs-on: ubuntu-latest
    steps:
      - name: Download image tarballs
        uses: actions/download-artifact@v7
        with:
          path: ${{ runner.temp }}/images
          pattern: image-*

      - name: Docker login to ghcr.io
        if: ${{ inputs.docker_registry == 'ghcr.io' }}
        uses: docker/login-action@v3
        with:
          registry: ${{ inputs.docker_registry }}
          username: ${{ github.actor }}
          password: ${{ github.token }}

      - name: Docker login to quay.io
        if: ${{ inputs.docker_registry == 'quay.io' }}
        uses: docker/login-action@v3
        with:
          registry: ${{ inputs.docker_registry }}
          username: ${{ secrets.HMPPS_QUAYIO_USER }}
          password: ${{ secrets.HMPPS_QUAYIO_TOKEN }}

      - name: Merge OCI layouts and push multi-arch image
        shell: bash
        run: |
          IMAGE="${{ inputs.docker_registry }}/${{ inputs.registry_org }}/${{ inputs.image_name || github.event.repository.name }}"
          VERSION="${{ needs.create_version.outputs.version }}"

          # Extract both platform tarballs
          mkdir -p "$RUNNER_TEMP/oci-amd64" "$RUNNER_TEMP/oci-arm64"
          tar -xf "$RUNNER_TEMP/images/image-linux-amd64/image.tar" -C "$RUNNER_TEMP/oci-amd64"
          tar -xf "$RUNNER_TEMP/images/image-linux-arm64/image.tar" -C "$RUNNER_TEMP/oci-arm64"

          # Create combined OCI layout with blobs from both platforms
          mkdir -p "$RUNNER_TEMP/oci/blobs/sha256"
          echo '{"imageLayoutVersion":"1.0.0"}' > "$RUNNER_TEMP/oci/oci-layout"
          mv "$RUNNER_TEMP"/oci-amd64/blobs/sha256/* "$RUNNER_TEMP/oci/blobs/sha256/"
          mv "$RUNNER_TEMP"/oci-arm64/blobs/sha256/* "$RUNNER_TEMP/oci/blobs/sha256/"

          # Build OCI image index (manifest list) from both platform manifests
          AMD64_MANIFEST=$(jq -c '.manifests[0] | del(.annotations) | .platform={"os":"linux","architecture":"amd64"}' "$RUNNER_TEMP/oci-amd64/index.json")
          ARM64_MANIFEST=$(jq -c '.manifests[0] | del(.annotations) | .platform={"os":"linux","architecture":"arm64"}' "$RUNNER_TEMP/oci-arm64/index.json")
          OCI_IMAGE_INDEX_PATH="$RUNNER_TEMP/oci/image-index.json"
          OCI_SOURCE_REF="multiarch"
          jq -n --argjson amd64 "$AMD64_MANIFEST" --argjson arm64 "$ARM64_MANIFEST" \
            '{"schemaVersion":2,"mediaType":"application/vnd.oci.image.index.v1+json","manifests":[$amd64,$arm64]}' \
            > "$OCI_IMAGE_INDEX_PATH"

          OCI_IMAGE_INDEX_SHA=$(sha256sum "$OCI_IMAGE_INDEX_PATH" | awk '{print $1}')
          OCI_IMAGE_INDEX_SIZE=$(wc -c < "$OCI_IMAGE_INDEX_PATH")
          cp "$OCI_IMAGE_INDEX_PATH" "$RUNNER_TEMP/oci/blobs/sha256/$OCI_IMAGE_INDEX_SHA"

          # Point the OCI layout index to the image index blob using a named reference.
          jq -n \
            --arg digest "sha256:${OCI_IMAGE_INDEX_SHA}" \
            --argjson size "$OCI_IMAGE_INDEX_SIZE" \
            --arg ref "$OCI_SOURCE_REF" \
            '{"schemaVersion":2,"manifests":[{"mediaType":"application/vnd.oci.image.index.v1+json","digest":$digest,"size":$size,"annotations":{"org.opencontainers.image.ref.name":$ref}}]}' \
            > "$RUNNER_TEMP/oci/index.json"

          # Push combined multi-arch image
          skopeo copy --all "oci:$RUNNER_TEMP/oci:$OCI_SOURCE_REF" "docker://${IMAGE}:${VERSION}"

          if [[ "${{ inputs.tag_latest }}" == "true" ]]; then
            skopeo copy --all "oci:$RUNNER_TEMP/oci:$OCI_SOURCE_REF" "docker://${IMAGE}:latest"
          fi

          if [[ -n "${{ inputs.additional_docker_tag }}" ]]; then
            skopeo copy --all "oci:$RUNNER_TEMP/oci:$OCI_SOURCE_REF" "docker://${IMAGE}:${{ inputs.additional_docker_tag }}"
          fi
