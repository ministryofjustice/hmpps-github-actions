name: 'failure Slack message'
description: 'Sends a slack message based on a file uploaded'
inputs:
  input_file:
    description: "filename to be read into a string"
    required: true
    default: "results.txt"
  channel_id:
    description: "Slack channel to send to"
    required: true
  SLACK_BOT_TOKEN:
    description: "important slack token"
    required: true
runs:
  using: "composite"
  steps:
    - name: process slack message results # returns SLACK_TXT
      uses: ministryofjustice/hmpps-github-actions/.github/actions/slack_prepare_results@v2 # WORKFLOW_VERSION
      id: slack_message_result 
      with:
        input_file: ${{ inputs.input_file }}
    - name: Slack - Send failure message
      uses: slackapi/slack-github-action@91efab103c0de0a537f72a35f6b8cda0ee76bf0a # v2.1.1
      with:
        method: chat.postMessage
        token: ${{ inputs.SLACK_BOT_TOKEN }}
        payload: |
          channel: ${{ inputs.channel_id }}
          blocks:
            - type: context
              elements:
                - type: mrkdwn
                  text: ":stop: Github Actions ${{ github.workflow }} - ${{ github.event.workflow_run.conclusion }}"
            - type: section
              text:
                type: mrkdwn
                text: "*${{ github.repository }}* ${{ github.workflow }} failed"
              accessory:
                type: button
                text:
                  type: plain_text
                  text: View job
                url: "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
            - type: context
              elements:
                - type: mrkdwn
                  text: |
                    Output: ```
                    ${{ steps.slack_message_result.outputs.SLACK_TXT }}
                    ```
            - type: divider
