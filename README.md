# hmpps-github-actions

Github actions for HMPPS projects


## Outline

This contains a library of Github actions for use by other projects. These include:

- security scans
- testing / deployments
- slack messaging templates

### Build / deploy workflows

- `deploy_env`: orchestrates deployment to a Cloud Platforms environment
- `docker_build`: builds a Docker image (including options for multiplatform)
- `docker_push`: pushes a Docker image

### Test workflows

#### Gradle
- `gradle_verify`: runs a Gradle check with optional Localstack & Postgres services
- `kotlin_validate`: runs a Gradle check

#### Node
- `node_build`: runs a node build
- `node_integration_tests`: runs integration tests against a node installation with optional Redis service
- `node_unit_tests`: runs unit tests against a node installation with optional Redis service

#### Helm
- `test_helm_lint`: validates Helm configurations


### Security workflows

- NPM dependency
- NPM outdated
- OWASP reports
- Trivy scan (image and filesystem)
- Veracode pipeline scan
- Veracode policy scan
- CodeQL scan (Github Actions and specific languages)

### Slack actions
- `slack_prepare_results`: filter non-Slack compatible text out of a text file and load it into a variable
- `slack_failure_results`: report on a failed operation with results as generated by slack_prepare_results
- `slack_codescan_notification`: links to the Codescan section of a repository to show the currently identified issues


## Migrating from CircleCI

Documentation for migrating security scans from CircleCI to Github Actions can be found in [this document](docs/security-migration.md).
Documentation for migrating build/test/deploy workflows from CircleCI to Github Actions can be found in [this document](docs/workflow-migration.md).

## Templates

Example templates that can be used to call shared workflows can be found in the `templates` directory.

*Note:* Examples of security scans can be found within the [Kotlin](https://github.com/ministryofjustice/hmpps-template-kotlin/tree/main/.github/workflows) and [Typescript](https://github.com/ministryofjustice/hmpps-template-typescript/tree/main/.github/workflows) repositories.


## Version Control

Workflows and actions are referred to by the tags associated with the current release, eg:

```
    - uses: ministryofjustice/hmpps-github-actions/.github/actions/security_owasp_reports@v2 # WORKFLOW_VERSION
```

When a new release is issued, all of these referred workflows (as well as the calling ones within applications) will need to be updated as well.

### Releasing

To perform a release:

* Update the WORKFLOW_VERSION across the project (if doing a major release)
* Ensure the `CHANGELOG.md` has been updated
* Create a pull request and get it merged
* Create a new release, and select create new tag, incrementing the version appropriately.
* Update the short version of the tags for `vx`, `vx.y`.

e.g: For a new version: `v2.1.5`
```sh
git tag -f v2 && git push -f origin v2
git tag -f v2.1 && git push -f origin v2.1
git tag -f v2.1.5 && git push -f origin v2.1.5
```

This requires maintenance permissions (or greater) on this repository.

## Testing Renovate Upgrade PRs for hmpps-github-actions

When Renovate creates a PR to upgrade dependencies or actions in hmpps-github-actions, you need to verify the changes before merging. Since hmpps-github-actions is a central library, its workflows are consumed by other repositories. 

Follow these steps to test the changes:

##### 1. Identify the Changed Workflow

Review the Renovate PR in hmpps-github-actions (example: https://github.com/ministryofjustice/hmpps-github-actions/pull/159).
Check which workflow/action file was modified (e.g.: .github/workflows/security_codeql.yml, .github/actions/trivy-scan/action.yml etc.).


##### 2. Find a Repository that uses these  workflow

Search for a repository that references the changed workflow from hmpps-github-actions.
Look in .github/workflows/*.yml files for lines like:
```
ministryofjustice/hmpps-github-actions/.github/workflows/<workflow>.yml@<version>
```
It may be that the update is within an action file rather than a parent workflow. To validate this, the parent workflow within hmpps-github-actions will also need to be modified to point to the patched action, eg in workflows/deploy_env.yaml, and then a repository that uses the workflow can be modified appropriately.

eg (in shared Github Workflow)
uses: ministryofjustice/hmpps-github-actions/.github/actions/slack_release_results@<branch_name>

Obviously, don't forget to put this back to the appropriate tag when the PR is raised.

##### 3. Create a Test Branch in Target Repository

In the identified repository:

Create a new branch (e.g., test-renovate-upgrade).
Update the workflow reference to point to the branch from the Renovate PR instead of the current version:
```
ministryofjustice/hmpps-github-actions/.github/workflows/<workflow>.yml@<renovate-branch-name>
```
Example:
```
ministryofjustice/hmpps-github-actions/.github/workflows/codeql.yml@renovate/github-codeql-action-3.x
```

##### 4. Ensure the New Version is Used in Setup Job

In the workflow steps, confirm that the setup job or action version matches the updated version from the Renovate PR.
For example, if Renovate upgraded github/codeql-action to v4, verify that the workflow uses v4.

##### 5. Trigger the Workflow

Push the branch and trigger the workflow (manually or via a commit).
Monitor the run in Actions tab to ensure:

The workflow executes successfully.
The updated action works as expected.

##### 6. Report Back

`If the test passes:` Approve and merge the Renovate PR in hmpps-github-actions.

**Note:** Once the PR has been merged, it is recommended to combine a number of updates together under a new patch tag, rather than tagging each individually. 
`If it fails:` Investigate and fix issues before merging.

### TODO

- Update the discovery tool to scan the version of Github Actions Workflows
